using FftSharp;
using NAudio.Wave;
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Diagnostics;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;

namespace psktest;
public partial class FormEncode : Form
{
    public FormEncode()
    {
        InitializeComponent();
        //rtbMessage.Text = "0000000000The Quick Brown Fox Jumps Over The Lazy Dog 1234567890 Times!1111111111";
        //rtbMessage.Text = "test123 test123";
    }

    private void btnUpdate_Click(object sender, EventArgs e)
    {
        string testMessage = "0101101101100101101101100101101101100101101101100101101101100101101101100101101101100101101101100101101101100101101101100111110011101001101101001010101010011101110010011101110100101010111001111111001010110100101111101001001110101100101011110010101011001010111010011011101001001101101100101010110010111010100100111111101001010101110010111011001101010100110111100100101010110011011010100111011100101011110010011011010010101010100111011100100110101110011111010010101011010010111101100100101101010010101011001111110100100101111010011101101001111111100101110111001010110110010110101100110101101001101010110011011011100101101110010011011010011111110010111011001110111001101111001111100111010010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110011111001110100111110011101001111100111010011111001110100111110011101001101101001010101010011101110010011101110100101010111001111111001010110100101111101001001110101100101011110010101011001010111010011011101001001101101100101010110010111010100100111111101001010101110010111011001101010100110111100100101010110011011010100111011100101011110010011011010010101010100111011100100110101110011111010010101011010010111101100100101101010010101011001111110100100101111010011101101001111111100101110111001010110110010110101100110101101001101010110011011011100101101110010011011010011111110010111011001110111001101111001111100111010010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110011111001110100111110011101001111100111010011111001110100111110011101001101101001010101010011101110010011101110100101010111001111111001010110100101111101001001110101100101011110010101011001010111010011011101001001101101100101010110010111010100100111111101001010101110010111011001101010100110111100100101010110011011010100111011100101011110010011011010010101010100111011100100110101110011111010010101011010010111101100100101101010010101011001111110100100101111010011101101001111111100101110111001010110110010110101100110101101001101010110011011011100101101110010011011010011111110010111011001110111001101111001111100111010010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110010111101100101011110011111001110100111110011101001111100111010011111001110100101101101100101101101100101101101100101101101100101101101100101101101100101101101100101101101100101101101100101101101100101101101100101101100111";
        bool[] messageBits = testMessage.ToArray().Select(x => x == '1').ToArray();

        double[] wave = MakeSound(messageBits);

        byte[] waveBytes = new byte[wave.Length * 2];
        for (int i = 0; i < wave.Length; i++)
        {
            byte[] values = BitConverter.GetBytes((Int16)(wave[i] * 30));
            waveBytes[i * 2] = values[1];
            waveBytes[i * 2 + 1] = values[0];
        }

        WaveFormat wavFormat = new(8000, 16, 1);
        MemoryStream wavMemoryStream = new(waveBytes);
        RawSourceWaveStream wavStream = new(wavMemoryStream, wavFormat);
        WaveOutEvent output = new();
        output.Init(wavStream);
        output.Play();

        formsPlot1.Plot.Clear();
        formsPlot1.Plot.AddSignal(wave, 8000);
        formsPlot1.Refresh();
    }

    private double[] MakeSound(bool[] bits)
    {
        int SampleRate = 8_000;
        double carrierFreq = 1000;
        double chirpsPerSecond = 31.25;
        int chirpSamples = (int)(SampleRate / chirpsPerSecond); // 256
        double[] wave = new double[chirpSamples * bits.Length];

        var windowFunc = new FftSharp.Windows.Cosine();

        double[] window = windowFunc.Create(chirpSamples);
        double[] windowStrongStart = windowFunc.Create(chirpSamples);
        double[] windowStrongEnd = windowFunc.Create(chirpSamples);
        double[] windowStrongBoth = windowFunc.Create(chirpSamples);

        for (int i = 0; i < window.Length / 2; i++)
        {
            windowStrongStart[i] = 1;
            windowStrongBoth[i] = 1;
        }

        for (int i = window.Length / 2; i < window.Length; i++)
        {
            windowStrongEnd[i] = 1;
            windowStrongBoth[i] = 1;
        }

        for (int i = 0; i < bits.Length; i++)
        {
            bool strongStart = (i > 0 && bits[i - 1] == bits[i]);
            bool strongEnd = (i < bits.Length - 1 && bits[i + 1] == bits[i]);

            double[] thisWindow;
            if (strongStart && strongEnd)
            {
                thisWindow = windowStrongBoth;
            }
            else if (strongStart)
            {
                thisWindow = windowStrongStart;
            }
            else if (strongEnd)
            {
                thisWindow = windowStrongEnd;
            }
            else
            {
                thisWindow = window;
            }

            int startIndex = i * chirpSamples;
            for (int j = 0; j < chirpSamples; j++)
            {
                int thisIndex = startIndex + j;
                double thisTime = (double)thisIndex / SampleRate;

                wave[startIndex + j] = Math.Cos(thisTime * carrierFreq * 2 * Math.PI) * thisWindow[j];

                if (!bits[i])
                {
                    wave[startIndex + j] = -wave[startIndex + j];
                }
            }
        }

        return wave;
    }
}
